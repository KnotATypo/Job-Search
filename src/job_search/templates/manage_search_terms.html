{% extends "base.html" %}
{% block content %}
    <div class="card search-terms-card">
        <h2>Manage Search Terms</h2>
        <p id="toggle-help" class="toggle-help">Toggle the remote switch to only include remote jobs for that search
            term.</p>
        <form id="add-term-form" class="add-term-form">
            <label for="new-term" class="visually-hidden">New search term</label>
            <input type="text" id="new-term" class="term-input" placeholder="Add new search term" required>
            <button type="submit" class="btn btn-success">Add</button>
        </form>
        <ul id="terms-list" class="terms-list">
            {% for term in terms %}
                <li class="term-row">
                    <div class="term-left">
                        <div class="term-label">
                            <span class="term-text">{{ term.term }}</span>
                            <button class="btn btn-secondary btn-sm"
                                    onclick="openSettings({{ term.id }}, '{{ term.term }}', {{ 'true' if term.remote else 'false' }}, '{{ term.location.value }}', this)">
                                Options
                            </button>
                        </div>
                    </div>
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Modal for configuring a search term -->
    <div id="settings-modal">
        <div id="settings-overlay"></div>
        <div class="modal-content card" style="position:relative;">
            <button type="button" aria-label="Close" onclick="closeSettings()"
                    style="position:absolute; top:8px; right:8px; background:transparent; border:none; font-size:20px; cursor:pointer;">
                &times;
            </button>
            <h3 style="margin-top:0;">Configure Search Term</h3>
            <form id="settings-form">
                <input type="hidden" id="settings-term-id">
                <div style="margin-bottom:8px;"><strong>Term: </strong><span id="settings-term-text"></span></div>
                <div style="margin-bottom:8px;"><label><input type="checkbox" id="settings-remote">Remote only</label>
                </div>
                <div style="margin-bottom:8px;">
                    <label>Location:
                        <select id="settings-location" name="location">
                            <option value="Australia">Australia</option>
                            <option value="Brisbane">Brisbane</option>
                            <option value="Melbourne">Melbourne</option>
                            <option value="Sydney">Sydney</option>
                            <option value="Adelaide">Adelaide</option>
                            <option value="Perth">Perth</option>
                            <option value="Darwin">Darwin</option>
                            <option value="Hobart">Hobart</option>
                        </select>
                    </label>
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end;">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-danger" id="modal-delete-btn">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.getElementById('add-term-form').addEventListener('submit', addTerm);

        function addTerm(e) {
            e.preventDefault();
            const term = document.getElementById('new-term').value;
            fetch('/search_terms', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'term=' + encodeURIComponent(term)
            })
                .then(() => {
                    location.reload();
                });
        }

        // Settings modal logic
        let _settingsInvokedButton = null;

        function openSettings(term_id, term, remote, location, btn) {
            _settingsInvokedButton = btn;

            document.getElementById('settings-term-id').value = term_id;
            document.getElementById('settings-term-text').textContent = term;
            document.getElementById('settings-remote').checked = remote;
            document.getElementById('settings-location').value = location;

            // Show modal
            const modal = document.getElementById('settings-modal');
            modal.style.display = 'flex';
            // Focus first control
            setTimeout(() => document.getElementById('settings-remote').focus(), 20);
        }

        function closeSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = 'none';
            if (_settingsInvokedButton) {
                _settingsInvokedButton.disabled = false;
                _settingsInvokedButton = null;
            }
        }

        // Save settings
        document.getElementById('settings-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = document.getElementById('settings-term-id').value;
            const payload = {
                remote: document.getElementById('settings-remote').checked,
                location: document.getElementById('settings-location').value || null,
                exclude_keywords: document.getElementById('settings-exclude').value || null
            };

            fetch('/search_terms/' + encodeURIComponent(id), {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
                .then(() => {
                    // If backend returns success, reload. Otherwise still try to reload to reflect changes.
                    location.reload();
                })
                .catch(() => {
                    location.reload();
                });
        });

        // Delete from modal
        document.getElementById('modal-delete-btn').addEventListener('click', function () {
            const id = document.getElementById('settings-term-id').value;
            if (!confirm('Delete this search term?')) return;
            this.disabled = true;
            fetch('/search_terms/' + encodeURIComponent(id), {method: 'DELETE'})
                .then(() => {
                    location.reload();
                });
        });

        // Click outside modal content closes it
        document.getElementById('settings-overlay').addEventListener('click', closeSettings);
    </script>
{% endblock %}
