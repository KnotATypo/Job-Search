{% extends "base.html" %}
{% block content %}
<div class="card search-terms-card">
    <h2>Manage Search Terms</h2>
    <p id="toggle-help" class="toggle-help">Toggle the remote switch to only include remote jobs for that search term.</p>
    <form id="add-term-form" class="add-term-form">
        <label for="new-term" class="visually-hidden">New search term</label>
        <input type="text" id="new-term" class="term-input" placeholder="Add new search term" required>
        <button type="submit" class="btn btn-success">Add</button>
    </form>
    <ul id="terms-list" class="terms-list"></ul>
</div>
<script>
function fetchTerms() {
    fetch('/search_terms')
        .then(response => response.json())
        .then(terms => {
            const list = document.getElementById('terms-list');
            list.innerHTML = '';
            terms.forEach(obj => {
                const li = document.createElement('li');
                li.className = 'term-row';

                // Left container: checkbox + label (inline)
                const left = document.createElement('div');
                left.className = 'term-left';

                // Inline label to wrap checkbox and text for better click target
                const termLabel = document.createElement('label');
                termLabel.className = 'term-label';

                // Native checkbox for remote
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = !!obj.remote;
                checkbox.dataset.termId = obj.id;
                checkbox.title = `Only include remote jobs for "${obj.term}" (currently ${obj.remote ? 'ON' : 'OFF'})`;
                checkbox.setAttribute('aria-label', `Only include remote jobs for ${obj.term}`);
                // point to explanatory help text for screen readers
                checkbox.setAttribute('aria-describedby', 'toggle-help');
                checkbox.className = 'term-checkbox';

                const labelText = document.createElement('span');
                labelText.className = 'term-text';
                labelText.textContent = obj.term;

                termLabel.appendChild(checkbox);
                termLabel.appendChild(labelText);

                // Small badge shown when remote flag is on
                const badge = document.createElement('span');
                badge.className = 'remote-badge';
                badge.textContent = 'REMOTE ONLY';
                badge.title = 'This term will only return fully-remote roles (onsite/hybrid excluded)';
                if (obj.remote) {
                    termLabel.appendChild(badge);
                }

                left.appendChild(termLabel);

                // Delete button (keeps existing delete-by-term behavior)
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.className = 'btn btn-danger btn-sm';
                delBtn.onclick = () => deleteTerm(obj.term);

                // On change, PATCH remote flag
                checkbox.addEventListener('change', (e) => {
                    const checked = e.target.checked;
                    const id = e.target.dataset.termId;
                    // disable while updating
                    e.target.disabled = true;
                    fetch('/search_terms/' + encodeURIComponent(id) + '/remote', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ remote: checked })
                    })
                    .then(res => res.json())
                    .then(json => {
                        if (!json || json.error) {
                            alert('Failed to update remote: ' + (json && json.error ? json.error : 'unknown'));
                            // revert
                            e.target.checked = !checked;
                        } else {
                            // Update badge state according to server response
                            const parentLabel = e.target.closest('.term-label');
                            if (json.remote) {
                                // append badge if missing
                                if (!parentLabel.querySelector('.remote-badge')) {
                                    const b = document.createElement('span');
                                    b.className = 'remote-badge';
                                    b.textContent = 'REMOTE ONLY';
                                    b.title = 'This term will only return fully-remote roles (onsite/hybrid excluded)';
                                    parentLabel.appendChild(b);
                                }
                                e.target.title = `Only include remote jobs for "${json.term}" (currently ON)`;
                            } else {
                                const existing = parentLabel.querySelector('.remote-badge');
                                if (existing) existing.remove();
                                e.target.title = `Only include remote jobs for "${json.term}" (currently OFF)`;
                            }
                        }
                    })
                    .catch(() => {
                        alert('Network error while updating remote');
                        e.target.checked = !checked;
                    })
                    .finally(() => { e.target.disabled = false; });
                });

                li.appendChild(left);
                li.appendChild(delBtn);
                list.appendChild(li);
            });
        });
}
function addTerm(e) {
    e.preventDefault();
    const term = document.getElementById('new-term').value;
    fetch('/search_terms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'term=' + encodeURIComponent(term)
    })
    .then(() => {
        document.getElementById('new-term').value = '';
        fetchTerms();
    });
}
function deleteTerm(term) {
    fetch('/search_terms/' + encodeURIComponent(term), { method: 'DELETE' })
        .then(() => fetchTerms());
}
document.getElementById('add-term-form').addEventListener('submit', addTerm);
window.onload = fetchTerms;
</script>
{% endblock %}
